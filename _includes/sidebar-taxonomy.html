<!-- _includes/sidebar-taxonomy.html -->
<aside class="sidebar">
  <!-- 月別 -->
  <section class="sb-block">
    <h3 class="sb-title">月別</h3>
    <ul id="sb-months" class="sb-list"></ul>
  </section>

  <!-- タグ -->
  <section class="sb-block">
    <h3 class="sb-title">タグ</h3>
    <ul id="sb-tags" class="sb-list"></ul>
  </section>
</aside>

<script>
(function(){
  // ====== 1) 投稿データの収集（ページ側の #postList から取得） ======
  const list = document.getElementById('postList');
  if (!list) return;
  const items = Array.from(list.querySelectorAll('.post-item'));

  // ユーティリティ
  const ym = (iso) => (iso || '').slice(0,7); // YYYY-MM

  // 集計：月別
  const monthMap = new Map(); // ym -> {count, label}
  items.forEach(li => {
    const d = li.dataset.date; // YYYY-MM-DD
    const key = ym(d);
    if (!key) return;
    const label = (d || '').slice(0,4) + '年' + (d || '').slice(5,7) + '月';
    const obj = monthMap.get(key) || { count: 0, label };
    obj.count += 1;
    monthMap.set(key, obj);
  });

  // 集計：タグ
  const tagMap = new Map(); // tag -> count
  items.forEach(li => {
    const tags = (li.dataset.tags || '').split(',').filter(Boolean);
    tags.forEach(t => tagMap.set(t, (tagMap.get(t)||0) + 1));
  });

  // ====== 2) 月リスト生成（新しい順） ======
  const months = Array.from(monthMap.entries())
    .sort((a,b) => b[0].localeCompare(a[0])); // key=YYYY-MM desc

  const ulMonths = document.getElementById('sb-months');
  months.forEach(([key, info]) => {
    const li = document.createElement('li');
    li.innerHTML = `<button class="sb-link" data-ym="${key}">${info.label} <span class="sb-count">${info.count}</span></button>`;
    ulMonths.appendChild(li);
  });
  // 「すべて」
  const liAllM = document.createElement('li');
  liAllM.innerHTML = `<button class="sb-link sb-all" data-ym="">すべて</button>`;
  ulMonths.appendChild(liAllM);

  // ====== 3) タグリスト生成（件数が多い順→同数は名前順） ======
  const tags = Array.from(tagMap.entries())
    .sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0], 'ja'));

  const ulTags = document.getElementById('sb-tags');
  tags.forEach(([name, count]) => {
    const li = document.createElement('li');
    li.innerHTML = `<button class="sb-link" data-tag="${name}">${name} <span class="sb-count">${count}</span></button>`;
    ulTags.appendChild(li);
  });
  const liAllT = document.createElement('li');
  liAllT.innerHTML = `<button class="sb-link sb-all" data-tag="">すべて</button>`;
  ulTags.appendChild(liAllT);

  // ====== 4) フィルタ挙動（同ページの #postList を絞り込み） ======
  function render({ymKey = '', tag = ''} = {}) {
    const ymk = (ymKey || '').trim();
    const tg  = (tag   || '').trim().toLowerCase();

    const filtered = items.filter(li => {
      const okYM  = !ymk || (li.dataset.date || '').startsWith(ymk);
      const okTag = !tg  || (li.dataset.tags || '').split(',').includes(tg);
      return okYM && okTag;
    }).sort((a,b) => b.dataset.date.localeCompare(a.dataset.date));

    list.innerHTML = '';
    filtered.forEach(li => list.appendChild(li));
  }

  // クリックで反映
  let stateYM = '', stateTag = '';
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.sb-link');
    if (!btn) return;

    if (btn.dataset.ym !== undefined) {
      stateYM = btn.dataset.ym || '';
      // 選択状態の見た目
      ulMonths.querySelectorAll('.sb-link').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    if (btn.dataset.tag !== undefined) {
      stateTag = (btn.dataset.tag || '').toLowerCase();
      ulTags.querySelectorAll('.sb-link').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    render({ymKey: stateYM, tag: stateTag});
  });

  // 初期表示（全件、新しい順）
  render({});
})();
</script>
