<!-- _includes/sidebar-taxonomy.html -->
<aside class="sidebar">
<!-- 月別 -->
<section class="sb-block">
  <h3 class="sb-title">月別</h3>

  {%- assign ym_list = "" | split: "" -%}
  {%- for p in site.posts -%}
    {%- assign year_num = p.date | date: "%Y" | plus: 0 -%}
    {%- if year_num >= 1000 -%}
      {%- assign ym = p.date | date: "%Y-%m" -%}
      {%- unless ym_list contains ym -%}
        {%- assign ym_list = ym_list | push: ym -%}
      {%- endunless -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign ym_sorted = ym_list | sort | reverse -%}

  <ul id="sb-months" class="sb-list">
    {%- for ym in ym_sorted -%}
      {%- assign y = ym | slice: 0, 4 -%}
      {%- assign m = ym | slice: 5, 2 -%}
      <li>
        <button class="sb-link" data-ym="{{ ym }}">
          {{ y }}年{{ m }}月
          <span class="sb-count" data-ym="{{ ym }}">0</span>
        </button>
      </li>
    {%- endfor -%}
    <li><button class="sb-link sb-all" data-ym="">All</button></li>
  </ul>
</section>



  <!-- タグ（件数降順→名前昇順） -->
  <section class="sb-block">
    <h3 class="sb-title">タグ</h3>

    {%- assign tag_pairs = site.tags -%}
    {%- assign buf = "" | split: "" -%}
    {%- for t in tag_pairs -%}
      {%- assign name = t[0] -%}
      {%- assign posts = t[1] -%}
      {%- assign count = posts | size -%}
      {%- assign entry = count | append: "|||" | append: name -%}
      {%- assign buf = buf | push: entry -%}
    {%- endfor -%}

    {%- assign sorted_by_count = buf | sort | reverse -%}

    {%- comment -%} 同数時は name 昇順に揃える {%- endcomment -%}
    {%- assign finalized = "" | split: "" -%}
    {%- assign current_block = "" | split: "" -%}
    {%- assign prev_count = "" -%}
    {%- for item in sorted_by_count -%}
      {%- assign parts = item | split: "|||" -%}
      {%- assign cnt   = parts[0] -%}
      {%- assign nm    = parts[1] -%}
      {%- if prev_count != "" and cnt != prev_count -%}
        {%- assign current_block = current_block | sort -%}
        {%- assign finalized = finalized | concat: current_block -%}
        {%- assign current_block = "" | split: "" -%}
      {%- endif -%}
      {%- assign current_block = current_block | push: nm | uniq -%}
      {%- assign prev_count = cnt -%}
    {%- endfor -%}
    {%- if current_block.size > 0 -%}
      {%- assign current_block = current_block | sort -%}
      {%- assign finalized = finalized | concat: current_block -%}
    {%- endif -%}

    <ul id="sb-tags" class="sb-list">
      {%- for name in finalized -%}
        {%- assign count = site.tags[name] | size -%}
        <li>
          <button class="sb-link" data-tag="{{ name | downcase | escape }}">
            {{ name }} <span class="sb-count">{{ count }}</span>
          </button>
        </li>
      {%- endfor -%}
      <li><button class="sb-link sb-all" data-tag="">All</button></li>
    </ul>
  </section>
</aside>

