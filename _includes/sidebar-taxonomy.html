<!-- _includes/sidebar-taxonomy.html -->
<aside class="sidebar">
  <section class="sb-block">
    <h3 class="sb-title">月別</h3>
    <ul id="sb-months" class="sb-list"></ul>
  </section>
  <section class="sb-block">
    <h3 class="sb-title">タグ</h3>
    <ul id="sb-tags" class="sb-list"></ul>
  </section>
</aside>

<script>
(function(){
  const list = document.getElementById('postList');
  if (!list) return;
  const items = Array.from(list.querySelectorAll('.post-item'));
  const ym = iso => (iso||'').slice(0,7);

  const monthMap = new Map();
  items.forEach(li => {
    const d = li.dataset.date; const key = ym(d);
    if (!key) return;
    const label = d.slice(0,4) + '年' + d.slice(5,7) + '月';
    const obj = monthMap.get(key) || {count:0, label};
    obj.count++; monthMap.set(key, obj);
  });

  const tagMap = new Map();
  items.forEach(li => {
    (li.dataset.tags||'').split(',').filter(Boolean).forEach(t => {
      tagMap.set(t, (tagMap.get(t)||0)+1);
    });
  });

  const ulM = document.getElementById('sb-months');
  Array.from(monthMap.entries())
    .sort((a,b)=> b[0].localeCompare(a[0]))
    .forEach(([k,info])=>{
      const li=document.createElement('li');
      li.innerHTML=`<button class="sb-link" data-ym="${k}">${info.label} <span class="sb-count">${info.count}</span></button>`;
      ulM.appendChild(li);
    });
  const liAllM=document.createElement('li');
  liAllM.innerHTML=`<button class="sb-link sb-all" data-ym="">すべて</button>`;
  ulM.appendChild(liAllM);

  const ulT = document.getElementById('sb-tags');
  Array.from(tagMap.entries())
    .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],'ja'))
    .forEach(([name,count])=>{
      const li=document.createElement('li');
      li.innerHTML=`<button class="sb-link" data-tag="${name}">${name} <span class="sb-count">${count}</span></button>`;
      ulT.appendChild(li);
    });
  const liAllT=document.createElement('li');
  liAllT.innerHTML=`<button class="sb-link sb-all" data-tag="">すべて</button>`;
  ulT.appendChild(liAllT);

  let stateYM='', stateTag='';
  function render(){
    const filtered = items.filter(li=>{
      const okYM = !stateYM || (li.dataset.date||'').startsWith(stateYM);
      const okTag = !stateTag || (li.dataset.tags||'').split(',').includes(stateTag);
      return okYM && okTag;
    }).sort((a,b)=> b.dataset.date.localeCompare(a.dataset.date));
    list.innerHTML=''; filtered.forEach(li=>list.appendChild(li));
  }
  document.addEventListener('click', e=>{
    const b=e.target.closest('.sb-link'); if(!b) return;
    if (b.dataset.ym !== undefined){
      stateYM=b.dataset.ym||''; ulM.querySelectorAll('.sb-link').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    }
    if (b.dataset.tag !== undefined){
      stateTag=(b.dataset.tag||''); ulT.querySelectorAll('.sb-link').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    }
    render();
  });
  render();
})();
</script>

